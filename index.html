<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>EMBER · Swift — Wake / Dream</title>
<meta name="theme-color" content="#0b0d11">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  :root{
    --bg:#0b0d11; --ink:#e9ecf1; --ink-dim:#aeb6c3;
    --ember:#ff6a3d; --lav:#d5c7ff; --card:#12161c; --card-2:#0f1318; --line:#1c2430; --accent:var(--ember);
  }
  [data-mode="dream"]{ --bg:#0a0b12; --ink:#e6e8ff; --accent:#d5c7ff; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:
      radial-gradient(1200px 800px at 80% -10%, rgba(255,106,61,.18), transparent 60%),
      radial-gradient(900px 600px at -10% 110%, rgba(213,199,255,.15), transparent 60%),
      var(--bg);
    color:var(--ink); font:14.5px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
  }
  header{
    padding:16px 20px; display:flex; align-items:center; justify-content:space-between; gap:12px;
    position:sticky; top:0; background:linear-gradient(180deg, rgba(10,12,17,.9), rgba(10,12,17,.6) 60%, transparent);
    backdrop-filter:saturate(1.2) blur(8px); z-index:10; border-bottom:1px solid var(--line);
  }
  .brand{display:flex; align-items:center; gap:10px; letter-spacing:.12em; text-transform:uppercase; font-weight:700}
  .ember-dot{width:10px; height:10px; border-radius:50%; background:var(--accent); box-shadow:0 0 18px var(--accent)}
  .mode{display:flex; gap:8px; align-items:center; background:var(--card); border:1px solid var(--line); border-radius:999px; padding:6px;}
  .mode button{appearance:none; border:0; background:transparent; color:var(--ink-dim); padding:6px 10px; border-radius:999px; cursor:pointer}
  .mode button.active{background:var(--accent); color:#0b0d11; font-weight:700}
  main{display:grid; grid-template-columns:1.1fr .9fr; gap:16px; padding:16px; max-width:1200px; margin:0 auto}
  @media (max-width:980px){ main{grid-template-columns:1fr; padding:12px} }
  .panel{background:linear-gradient(180deg, var(--card), var(--card-2)); border:1px solid var(--line); border-radius:16px; overflow:hidden;}
  .panel h2{margin:0; padding:14px 16px; border-bottom:1px solid var(--line); font-size:13px; letter-spacing:.12em; text-transform:uppercase; color:var(--ink-dim)}
  .player-wrap{padding:12px}
  .player{aspect-ratio:16/9; width:100%; border:0; border-radius:12px; background:#000}
  .controls{margin-top:10px; display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between}
  .btn, select, input[type="range"]{background:#12161c; color:var(--ink); border:1px solid var(--line); border-radius:10px; padding:8px 10px; font:inherit}
  .btn{cursor:pointer}
  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .list{max-height:460px; overflow:auto}
  .track{display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center; padding:10px 12px; border-bottom:1px solid var(--line)}
  .track.active{background:rgba(255,255,255,.03); border-left:3px solid var(--accent)}
  .seed{font-size:11px; color:var(--ink-dim)}
  .pill{font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid var(--line); color:var(--ink-dim)}
  .tone{padding:12px 12px 14px; display:grid; gap:10px; border-top:1px dashed var(--line)}
  .tone-grid{display:grid; grid-template-columns:1fr 1fr; gap:8px}
  .meta{padding:12px; color:var(--ink-dim); font-size:13px; border-top:1px solid var(--line)}
  .mantras{display:grid; gap:6px; padding:10px 12px; border-top:1px dashed var(--line); background:linear-gradient(180deg, rgba(255,106,61,.07), transparent)}
  .mantras div{font-size:12.5px}
  .tiny{opacity:.8; font-size:12px}
  .loop{margin-left:8px}
  .mini{
    position:fixed; right:12px; bottom:12px; z-index:20;
    display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:12px;
    background:rgba(18,22,28,.92); border:1px solid var(--line); backdrop-filter:blur(8px);
  }
  .mini strong{font-size:12px}
  .mini .btn{padding:6px 8px}
</style>
</head>
<body data-mode="wake">
<header>
  <div class="brand"><span class="ember-dot"></span> EMBER · Swift</div>
  <div class="mode">
    <button id="wakeBtn" class="active" aria-pressed="true">Wake</button>
    <button id="dreamBtn" aria-pressed="false">Dream</button>
  </div>
</header>

<main>
  <section class="panel">
    <h2>Player · Wake / Dream</h2>
    <div class="player-wrap">
      <!-- YouTube iframe managed by IFrame API -->
      <div id="ytContainer"><div id="yt" class="player"></div></div>

      <div class="controls">
        <div class="row">
          <button class="btn" id="prev">◀︎ Prev</button>
          <button class="btn" id="next">Next ▶︎</button>
          <label class="pill"><input id="loop" class="loop" type="checkbox" checked> Loop queue</label>
        </div>
        <div class="row">
          <select id="videoSelect" title="Choose a song"></select>
          <button class="btn" id="play">Play</button>
          <button class="btn" id="pause">Pause</button>
          <button class="btn" id="bgMode">Background Mode: Off</button>
          <button class="btn" id="airplayBtn" title="AirPlay">AirPlay ▸</button>
        </div>
      </div>

      <div class="tone">
        <div class="row"><strong>Tone bed</strong><span class="tiny"> · 128.15 / 160 / 256 Hz</span></div>
        <div class="tone-grid">
          <div class="row">
            <button class="btn" id="toneToggle" aria-pressed="false">Enable Tone</button>
            <select id="freq">
              <option value="128.15">128.15 Hz (root+)</option>
              <option value="160">160 Hz (magnet)</option>
              <option value="256">256 Hz (clarity)</option>
            </select>
          </div>
          <div class="row">
            <input id="gain" type="range" min="0" max="1" step="0.01" value="0.18" aria-label="Tone volume">
            <button class="btn" id="mute">Mute</button>
          </div>
        </div>
      </div>

      <div class="meta" id="meta"></div>
      <div class="mantras" id="mantras"></div>
    </div>
  </section>

  <section class="panel">
    <h2>Seven · Seeds (+ Haze)</h2>
    <div class="list" id="trackList"></div>
    <div class="meta tiny">Tip: Start playback, then enable Background Mode for screen-off listening. AirPlay targets the background loop.</div>
  </section>
</main>

<!-- Hidden background audio (looping WAV, AirPlay-able, continues screen off) -->
<audio id="bgAudio" loop playsinline x-webkit-airplay="allow" style="display:none"></audio>

<!-- Mini player -->
<div class="mini" id="mini">
  <strong id="miniTitle">—</strong>
  <button class="btn" id="mPrev">◀︎</button>
  <button class="btn" id="mPlay">Play</button>
  <button class="btn" id="mPause">Pause</button>
  <button class="btn" id="mNext">▶︎</button>
  <button class="btn" id="mTone">Tone</button>
  <button class="btn" id="mAir">▸ AirPlay</button>
</div>

<!-- YouTube IFrame API (required for reliable "ended" detection and controls) -->
<script src="https://www.youtube.com/iframe_api"></script>
<script>
/* ---------- Tracks (same set incl. Lavender Haze) ---------- */
const TRACKS = [
  { title:"Lavender Haze", id:"h8DLofLM7No", fallback:"mkR_Qwix4Ho",
    colorWake:"#b38be7", colorDream:"#cbb6ff",
    wake:{ mantra:"Hold the haze", seed:"Breathe 4-4 under a lavender dome; keep outside noise out." },
    dream:{ mantra:"Glow stays ours", seed:"Violet mist expands and softens until only warmth remains." },
    note:"Private-aura protection / dreamlike unity field."
  },
  { title:"Lover", id:"-BjZmE2gtdo", fallback:"cvUAzpn48xA",
    colorWake:"#f2a2b6", colorDream:"#d5c7ff",
    wake:{ mantra:"We are whole", seed:"Rose ring around both hearts." },
    dream:{ mantra:"Soul’s embrace", seed:"Lavender orb pulsing between you." },
    note:"Resonance of union / safe heart."
  },
  { title:"august", id:"nn_0zPAfyo8", fallback:"yA8Lm2XbQVk",
    colorWake:"#f4d06f", colorDream:"#f2b4a6",
    wake:{ mantra:"Soft light lingers", seed:"Warm memory → solar glow." },
    dream:{ mantra:"Fade into you", seed:"Float the scene away like mist." },
    note:"Transient magic / memory cultivation."
  },
  { title:"exile (ft. Bon Iver)", id:"osdoLjUNFnA", fallback:"ZmPIi5kCc2k",
    colorWake:"#7f8aa5", colorDream:"#e6eef8",
    wake:{ mantra:"Call and echo", seed:"Figure-8 at heart level." },
    dream:{ mantra:"Cross our miles", seed:"Silver thread between two shores." },
    note:"Dual fields, meeting edges."
  },
  { title:"Delicate", id:"tCXGJQYZ9JA", fallback:"tCXGJQYZ9JA",
    colorWake:"#ffe6b3", colorDream:"#fff7e6",
    wake:{ mantra:"Softly revealed", seed:"Relax jaw/eyes; say your name kindly." },
    dream:{ mantra:"Tender core", seed:"Cup hands at sternum; small candle." },
    note:"Vulnerability threshold."
  },
  { title:"State of Grace (Taylor’s Version)", id:"-mrC5tRkxrY", fallback:"-mrC5tRkxrY",
    colorWake:"#8fe3f6", colorDream:"#bfeff8",
    wake:{ mantra:"Wide horizon", seed:"Spine tall; crown to sky." },
    dream:{ mantra:"Ever gentle", seed:"Wind through trees; long exhale." },
    note:"Open sky, foundational field."
  },
  { title:"All Too Well — Short Film", id:"tollGa3S0o8", fallback:"sRxrwjOtIag",
    colorWake:"#7a1f2b", colorDream:"#ad5a67",
    wake:{ mantra:"Remember, release", seed:"Name the lesson; dissolve." },
    dream:{ mantra:"Wash me free", seed:"Warm rain rinses the scene." },
    note:"Depth, memory excavation."
  },
  { title:"The Archer", id:"8KpKc3C9V3w", fallback:"8KpKc3C9V3w",
    colorWake:"#b5c7ff", colorDream:"#cdbdff",
    wake:{ mantra:"Aim into light", seed:"Steady target; breath to center." },
    dream:{ mantra:"See my heart", seed:"Hand on chest; count 5 beats." },
    note:"Inner witness, shadow/light integration."
  }
];

/* ---------- State & elements ---------- */
let index=0, loopQueue=true;
const app=document.body;
const videoSelect=document.getElementById('videoSelect');
const prevBtn=document.getElementById('prev'), nextBtn=document.getElementById('next');
const playBtn=document.getElementById('play'), pauseBtn=document.getElementById('pause');
const loopChk=document.getElementById('loop');
const meta=document.getElementById('meta'), mantras=document.getElementById('mantras');
const trackList=document.getElementById('trackList');
const wakeBtn=document.getElementById('wakeBtn'), dreamBtn=document.getElementById('dreamBtn');
const bgBtn=document.getElementById('bgMode'), airBtn=document.getElementById('airplayBtn');
const bgAudio=document.getElementById('bgAudio');
const miniTitle=document.getElementById('miniTitle');
const mPrev=document.getElementById('mPrev'), mNext=document.getElementById('mNext');
const mPlay=document.getElementById('mPlay'), mPause=document.getElementById('mPause');
const mTone=document.getElementById('mTone'), mAir=document.getElementById('mAir');

/* ---------- Build list ---------- */
function option(t,i){ const o=document.createElement('option'); o.value=i; o.textContent=t.title; return o; }
TRACKS.forEach((t,i)=>videoSelect.appendChild(option(t,i)));

function trackRow(t,i){
  const row=document.createElement('div'); row.className='track'; row.dataset.index=i;
  const dot=document.createElement('div'); dot.className='ember-dot'; dot.style.width='8px'; dot.style.height='8px';
  dot.style.background=app.dataset.mode==='wake'?t.colorWake:t.colorDream;
  const title=document.createElement('div'); title.innerHTML=`<strong>${t.title}</strong><div class="tiny">${t.note}</div>`;
  const actions=document.createElement('div');
  const seed=document.createElement('button'); seed.className='btn'; seed.textContent='Seed'; seed.onclick=()=>showSeed(i);
  actions.appendChild(seed);
  row.appendChild(dot); row.appendChild(title); row.appendChild(actions);
  row.onclick=(e)=>{ if(e.target===seed) return; load(i,true); };
  return row;
}
function rebuildList(){ trackList.innerHTML=''; TRACKS.forEach((t,i)=>trackList.appendChild(trackRow(t,i))); highlightActive(); }
function highlightActive(){ [...trackList.children].forEach(el=>el.classList.toggle('active', +el.dataset.index===index)); }

/* ---------- YouTube Player (with reliable end detection) ---------- */
let player=null;
function onYouTubeIframeAPIReady(){
  player = new YT.Player('yt', {
    width: '100%', height: '100%', videoId: TRACKS[0].id,
    playerVars: { rel:0, modestbranding:1, playsinline:1, autoplay:0 },
    events: {
      'onReady': ()=>{ load(0,false); },
      'onStateChange': onPlayerStateChange
    }
  });
}
function onPlayerStateChange(ev){
  if(ev.data === YT.PlayerState.ENDED){
    step(+1);
  }
}

/* ---------- Load / Play controls ---------- */
function load(i,scrollTo=false){
  index=(i+TRACKS.length)%TRACKS.length;
  videoSelect.value=index;
  const t=TRACKS[index];
  if(player && player.loadVideoById){ player.loadVideoById(t.id, 0, "large"); player.pauseVideo(); }
  updateMeta(); highlightActive(); setMediaSession(t.title);
  if(scrollTo){ trackList.children[index]?.scrollIntoView({block:'nearest'}); }
}
function play(){ if(player) player.playVideo(); }
function pause(){ if(player) player.pauseVideo(); }
prevBtn.onclick=()=>step(-1); nextBtn.onclick=()=>step(+1);
mPrev.onclick=()=>step(-1); mNext.onclick=()=>step(+1);
loopChk.onchange=()=>{ loopQueue=loopChk.checked; };
videoSelect.onchange=()=>{ load(+videoSelect.value,true); };
playBtn.onclick=play; pauseBtn.onclick=pause;
mPlay.onclick=play; mPause.onclick=pause;

function step(dir){
  const next = index+dir;
  if(next<0 && !loopQueue) return;
  if(next>=TRACKS.length && !loopQueue) return;
  load((next+TRACKS.length)%TRACKS.length,true);
}

/* ---------- Mode ---------- */
wakeBtn.onclick=()=>setMode('wake'); dreamBtn.onclick=()=>setMode('dream');
function setMode(m){
  app.dataset.mode=m;
  wakeBtn.classList.toggle('active', m==='wake');
  dreamBtn.classList.toggle('active', m==='dream');
  wakeBtn.setAttribute('aria-pressed', m==='wake'); dreamBtn.setAttribute('aria-pressed', m==='dream');
  updateMeta(); rebuildList();
}

/* ---------- Tone bed (Web Audio) w/ 128.15 ---------- */
let AC=null, osc=null, gainNode=null, muted=false;
const toneToggle=document.getElementById('toneToggle');
const freqSel=document.getElementById('freq');
const gain=document.getElementById('gain');
const mute=document.getElementById('mute');
toneToggle.onclick=()=>{
  if(!AC){
    AC=new (window.AudioContext||window.webkitAudioContext)();
    osc=AC.createOscillator(); gainNode=AC.createGain();
    osc.type='sine'; osc.frequency.value=+freqSel.value; // fractional ok (128.15)
    gainNode.gain.value=+gain.value;
    osc.connect(gainNode).connect(AC.destination);
    osc.start();
    toneToggle.textContent='Disable Tone';
    toneToggle.setAttribute('aria-pressed','true');
  }else{
    try{osc.stop();}catch(e){} AC.close(); AC=null; osc=null; gainNode=null;
    toneToggle.textContent='Enable Tone';
    toneToggle.setAttribute('aria-pressed','false');
  }
};
freqSel.onchange=()=>{ if(osc) osc.frequency.value=+freqSel.value; };
gain.oninput=()=>{ if(gainNode) gainNode.gain.value=+gain.value; };
mute.onclick=()=>{
  muted=!muted; if(gainNode){ gainNode.gain.value = muted ? 0 : +gain.value; }
  mute.textContent = muted ? 'Unmute' : 'Mute';
};
mTone.onclick=()=>toneToggle.click();

/* ---------- Background Mode + AirPlay (robust) ---------- */
let bgOn=false;
document.getElementById('mAir').onclick=()=>airBtn.click();
airBtn.onclick=()=>{
  if(bgAudio && typeof bgAudio.webkitShowPlaybackTargetPicker==='function'){
    try{ bgAudio.webkitShowPlaybackTargetPicker(); }catch(e){}
  }else{ alert("AirPlay picker not available here."); }
};
bgBtn.onclick=toggleBG;
function toggleBG(){
  if(!bgOn){
    // Ensure a real audio stream (inline WAV) is present and audible:
    bgAudio.src = makeWavDataUrl(+freqSel.value || 128.15, 3, 0.06); // 3s loop, slightly louder
    const start = bgAudio.play();
    if(start && start.catch){ start.catch(()=>alert("Tap Play once, then enable Background Mode.")); }
    bgOn=true; bgBtn.textContent='Background Mode: On';
  }else{
    bgAudio.pause(); bgOn=false; bgBtn.textContent='Background Mode: Off';
  }
}

/* Media Session: lock-screen control */
function setMediaSession(title){
  if('mediaSession' in navigator){
    navigator.mediaSession.metadata = new MediaMetadata({ title, artist:'Taylor Swift · EMBER', album:'Illumina Anchor' });
    navigator.mediaSession.setActionHandler('previoustrack', ()=>step(-1));
    navigator.mediaSession.setActionHandler('nexttrack', ()=>step(+1));
    navigator.mediaSession.setActionHandler('play', play);
    navigator.mediaSession.setActionHandler('pause', pause);
  }
}

/* ---------- UI updates ---------- */
function updateMeta(){
  const t=TRACKS[index], pack=app.dataset.mode==='wake'?t.wake:t.dream;
  miniTitle.textContent=t.title;
  meta.innerHTML = `<strong>${t.title}</strong> · <span class="pill">${app.dataset.mode==='wake'?'Wake':'Dream'}</span>`;
  mantras.innerHTML = `<div><strong>Mantra:</strong> ${pack.mantra}</div><div class="seed"><strong>Seed:</strong> ${pack.seed}</div>`;
  document.documentElement.style.setProperty('--accent', app.dataset.mode==='wake'?t.colorWake:t.colorDream);
}
function showSeed(i){
  const t=TRACKS[i], pack = app.dataset.mode==='wake'?t.wake:t.dream;
  alert(`${t.title} — ${app.dataset.mode.toUpperCase()}\n\nMantra: ${pack.mantra}\n\nSeed: ${pack.seed}`);
}

/* ---------- Inline WAV builder (fractional freq OK) ---------- */
function makeWavDataUrl(freq, seconds, amplitude){
  const rate=44100, N=Math.floor(rate*seconds), buf=new Uint8Array(44+N*2);
  function wr(off, val, bytes){ for(let i=0;i<bytes;i++) buf[off+i]=(val>>(8*i))&255; }
  // RIFF/WAVE header
  const chunkSize=36+N*2; buf.set([82,73,70,70]); wr(4, chunkSize, 4); buf.set([87,65,86,69],8);
  buf.set([102,109,116,32],12); wr(16,16,4); wr(20,1,2); wr(22,1,2); wr(24,rate,4); wr(28,rate*2,4); wr(32,2,2); wr(34,16,2);
  buf.set([100,97,116,97],36); wr(40,N*2,4);
  // samples
  for(let n=0;n<N;n++){
    const t=n/rate, s=Math.sin(2*Math.PI*freq*t)*amplitude; // freq may be 128.15
    const v=Math.max(-1,Math.min(1,s)); const w=(v*32767)|0; // 16-bit
    wr(44+n*2, w<0? w+65536 : w, 2);
  }
  return 'data:audio/wav;base64,'+btoa(String.fromCharCode(...buf));
}

/* ---------- Init ---------- */
function rebuild(){ rebuildList(); load(0,false); }
rebuild();
</script>
</body>
</html>
